# 多环境配置策略

<cite>
**本文档引用的文件**
- [app.config.development.ts](file://packages\vue3\example\.ldesign\app.config.development.ts)
- [app.config.production.ts](file://packages\vue3\example\.ldesign\app.config.production.ts)
- [app.config.staging.ts](file://packages\vue3\example\.ldesign\app.config.staging.ts)
- [app.config.test.ts](file://packages\vue3\example\.ldesign\app.config.test.ts)
- [config-manager.ts](file://packages\core\src\config\config-manager.ts)
- [types.ts](file://packages\core\src\config\types.ts)
- [launcher.config.development.ts](file://packages\vue3\example\.ldesign\launcher.config.development.ts)
- [launcher.config.production.ts](file://packages\vue3\example\.ldesign\launcher.config.production.ts)
- [main.ts](file://packages\vue3\example\src\main.ts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
engine框架提供了一套完整的多环境配置管理策略，支持开发、测试、预发布和生产等不同环境的配置隔离。通过`app.config.*.ts`文件实现环境特定配置，配置管理器根据当前环境自动加载对应的配置文件。系统支持配置优先级机制，环境变量可以覆盖文件配置，并支持条件性配置加载。本文档详细说明了该配置系统的实现机制、使用方法和最佳实践。

## 项目结构
engine框架的多环境配置系统采用基于文件的配置策略，通过命名约定实现环境隔离。配置文件位于`.ldesign`目录下，使用`app.config.{environment}.ts`命名模式。

```mermaid
graph TD
A[配置系统] --> B[应用配置]
A --> C[构建配置]
B --> D[app.config.development.ts]
B --> E[app.config.test.ts]
B --> F[app.config.staging.ts]
B --> G[app.config.production.ts]
C --> H[launcher.config.development.ts]
C --> I[launcher.config.test.ts]
C --> J[launcher.config.staging.ts]
C --> K[launcher.config.production.ts]
```

**图示来源**
- [app.config.development.ts](file://packages\vue3\example\.ldesign\app.config.development.ts)
- [app.config.production.ts](file://packages\vue3\example\.ldesign\app.config.production.ts)
- [launcher.config.development.ts](file://packages\vue3\example\.ldesign\launcher.config.development.ts)
- [launcher.config.production.ts](file://packages\vue3\example\.ldesign\launcher.config.production.ts)

**本节来源**
- [app.config.development.ts](file://packages\vue3\example\.ldesign\app.config.development.ts)
- [app.config.production.ts](file://packages\vue3\example\.ldesign\app.config.production.ts)

## 核心组件
多环境配置系统的核心是`ConfigManagerImpl`类，它负责管理配置的加载、合并、监听和环境切换。系统通过`Environment`类型定义支持多种环境，并提供灵活的配置源和加载器机制。

**本节来源**
- [config-manager.ts](file://packages\core\src\config\config-manager.ts)
- [types.ts](file://packages\core\src\config\types.ts)

## 架构概述
engine框架的多环境配置架构采用分层设计，从配置文件到运行时配置的完整流程。

```mermaid
graph TD
A[环境变量] --> |最高优先级| B[配置管理器]
C[app.config.*.ts文件] --> |文件配置| B
D[默认配置] --> |基础配置| B
B --> E[运行时配置]
E --> F[应用使用]
G[环境切换] --> |触发重新加载| B
H[配置监听] --> |通知变化| F
```

**图示来源**
- [config-manager.ts](file://packages\core\src\config\config-manager.ts)
- [types.ts](file://packages\core\src\config\types.ts)

## 详细组件分析

### 配置管理器分析
`ConfigManagerImpl`是多环境配置系统的核心实现，提供完整的配置管理功能。

#### 类结构分析
```mermaid
classDiagram
class ConfigManagerImpl {
-config : ConfigObject
-sources : ConfigSource[]
-loaders : ConfigLoader[]
-environment : Environment
-options : ConfigOptions
-watchers : Map<string, Set<Function>>
+get(key, defaultValue) : T
+set(key, value) : void
+setAll(config) : void
+has(key) : boolean
+delete(key) : boolean
+getAll() : ConfigObject
+clear() : void
+addSource(source) : void
+addLoader(loader) : Promise<void>
+reload() : Promise<void>
+getEnvironment() : Environment
+setEnvironment(env) : void
+validate() : Promise<boolean>
+watch(key, callback) : Function
+export(format) : string
+merge(config, deep) : void
-loadEnvironmentVariables() : void
-mergeSourcesConfig() : void
-hasConflict(config) : boolean
-notifyWatchers(key, value, oldValue) : void
-deepClone(obj) : T
-isSerializable(obj) : boolean
-recursiveClone(obj) : T
-deepMerge(target, source) : ConfigObject
}
class ConfigSource {
+name : string
+priority : number
+data : ConfigObject
+readonly? : boolean
}
class ConfigLoader {
+name : string
+load() : Promise<ConfigObject> | ConfigObject
+watch?(callback) : Function
}
class ConfigOptions {
+environment? : Environment
+envPrefix? : string
+loadEnv? : boolean
+configFiles? : string[]
+defaults? : ConfigObject
+validator? : ConfigValidator
}
ConfigManagerImpl --> ConfigSource : "使用"
ConfigManagerImpl --> ConfigLoader : "使用"
ConfigManagerImpl --> ConfigOptions : "使用"
```

**图示来源**
- [config-manager.ts](file://packages\core\src\config\config-manager.ts)
- [types.ts](file://packages\core\src\config\types.ts)

### 应用配置分析
不同环境的应用配置文件定义了环境特定的配置项，如API地址、调试功能和分析统计等。

#### 开发环境配置
```mermaid
flowchart TD
Start([开发环境配置]) --> API["API 配置"]
API --> BaseURL["baseUrl: http://localhost:8080/api"]
API --> Timeout["timeout: 30000"]
Start --> Features["功能配置"]
Features --> Analytics["enableAnalytics: false"]
Features --> Debug["enableDebug: true"]
Start --> Theme["主题配置"]
Theme --> Color["primaryColor: '#42b883'"]
Theme --> Mode["mode: 'light'"]
Start --> Dev["开发配置"]
Dev --> Panel["showConfigPanel: true"]
Dev --> LogLevel["logLevel: 'debug'"]
Dev --> HotReload["enableHotReload: true"]
style Start fill:#f9f,stroke:#333
style API fill:#bbf,stroke:#333
style Features fill:#bbf,stroke:#333
style Theme fill:#bbf,stroke:#333
style Dev fill:#bbf,stroke:#333
```

**图示来源**
- [app.config.development.ts](file://packages\vue3\example\.ldesign\app.config.development.ts)

#### 生产环境配置
```mermaid
flowchart TD
Start([生产环境配置]) --> API["API 配置"]
API --> BaseURL["baseUrl: https://api.example.com"]
API --> Timeout["timeout: 30000"]
Start --> Features["功能配置"]
Features --> Analytics["enableAnalytics: true"]
Features --> Debug["enableDebug: false"]
Start --> Theme["主题配置"]
Theme --> Color["primaryColor: '#42b883'"]
Theme --> Mode["mode: 'light'"]
Start --> Dev["开发配置"]
Dev --> Panel["showConfigPanel: false"]
Dev --> LogLevel["logLevel: 'warn'"]
Dev --> HotReload["enableHotReload: false"]
style Start fill:#f9f,stroke:#333
style API fill:#bbf,stroke:#333
style Features fill:#bbf,stroke:#333
style Theme fill:#bbf,stroke:#333
style Dev fill:#bbf,stroke:#333
```

**图示来源**
- [app.config.production.ts](file://packages\vue3\example\.ldesign\app.config.production.ts)

### 构建配置分析
构建配置文件定义了不同环境的构建参数，如输出目录、代码压缩和sourcemap等。

#### 开发环境构建配置
```mermaid
flowchart TD
Start([开发环境构建配置]) --> Build["构建配置"]
Build --> OutDir["outDir: 'dist-dev'"]
Build --> Sourcemap["sourcemap: true"]
Build --> Minify["minify: false"]
Build --> Target["target: 'esnext'"]
Start --> Server["开发服务器配置"]
Server --> Port["port: 5174"]
Server --> Open["open: true"]
Server --> HMR["hmr: true"]
Start --> Define["全局变量"]
Define --> DEV["__DEV__: true"]
Define --> API["__API_URL__: 'http://localhost:8080/api'"]
Define --> ENV["__ENV__: 'development'"]
style Start fill:#f9f,stroke:#333
style Build fill:#bbf,stroke:#333
style Server fill:#bbf,stroke:#333
style Define fill:#bbf,stroke:#333
```

**图示来源**
- [launcher.config.development.ts](file://packages\vue3\example\.ldesign\launcher.config.development.ts)

#### 生产环境构建配置
```mermaid
flowchart TD
Start([生产环境构建配置]) --> Build["构建配置"]
Build --> OutDir["outDir: 'dist-prod'"]
Build --> Sourcemap["sourcemap: false"]
Build --> Minify["minify: true"]
Build --> Target["target: 'es2015'"]
Build --> CSSMinify["cssMinify: true"]
Start --> Server["预览服务器配置"]
Server --> Port["port: 4175"]
Server --> Open["open: false"]
Start --> Define["全局变量"]
Define --> DEV["__DEV__: false"]
Define --> API["__API_URL__: 'https://api.example.com'"]
Define --> ENV["__ENV__: 'production'"]
Start --> Optimization["优化配置"]
Optimization --> Minify["minify: 'esbuild'"]
Optimization --> TreeShaking["treeShaking.enabled: true"]
style Start fill:#f9f,stroke:#333
style Build fill:#bbf,stroke:#333
style Server fill:#bbf,stroke:#333
style Define fill:#bbf,stroke:#333
style Optimization fill:#bbf,stroke:#333
```

**图示来源**
- [launcher.config.production.ts](file://packages\vue3\example\.ldesign\launcher.config.production.ts)

**本节来源**
- [app.config.development.ts](file://packages\vue3\example\.ldesign\app.config.development.ts)
- [app.config.production.ts](file://packages\vue3\example\.ldesign\app.config.production.ts)
- [launcher.config.development.ts](file://packages\vue3\example\.ldesign\launcher.config.development.ts)
- [launcher.config.production.ts](file://packages\vue3\example\.ldesign\launcher.config.production.ts)

## 依赖分析
多环境配置系统依赖于多个核心组件，形成完整的配置管理链。

```mermaid
graph TD
A[入口文件] --> B[配置管理器]
B --> C[配置类型]
B --> D[配置源]
B --> E[配置加载器]
C --> F[环境类型]
C --> G[配置选项]
D --> H[文件配置源]
D --> I[环境变量源]
E --> J[TS配置加载器]
E --> K[JSON配置加载器]
A --> L[核心引擎]
L --> M[插件系统]
L --> N[中间件系统]
M --> B
N --> B
```

**图示来源**
- [config-manager.ts](file://packages\core\src\config\config-manager.ts)
- [types.ts](file://packages\core\src\config\types.ts)
- [main.ts](file://packages\vue3\example\src\main.ts)

**本节来源**
- [config-manager.ts](file://packages\core\src\config\config-manager.ts)
- [types.ts](file://packages\core\src\config\types.ts)
- [main.ts](file://packages\vue3\example\src\main.ts)

## 性能考虑
配置管理系统在设计时考虑了性能优化，特别是在配置读取和缓存方面。

- **配置缓存**：`getAll()`方法使用1秒的TTL缓存，避免频繁的深克隆操作
- **高效克隆**：优先使用`structuredClone`，降级到JSON序列化，最后使用递归克隆
- **事件通知**：使用Map存储监听器，确保O(1)的查找性能
- **配置合并**：按优先级排序配置源，确保高优先级配置覆盖低优先级配置

## 故障排除指南
在使用多环境配置系统时，可能会遇到一些常见问题：

- **环境变量不生效**：确保环境变量以`APP_`前缀开头
- **配置未更新**：调用`reload()`方法重新加载配置
- **类型错误**：检查配置文件的导出是否为默认导出
- **路径问题**：确保配置文件路径正确，特别是相对路径

**本节来源**
- [config-manager.ts](file://packages\core\src\config\config-manager.ts)
- [types.ts](file://packages\core\src\config\types.ts)

## 结论
engine框架的多环境配置策略提供了一套完整、灵活且高性能的配置管理解决方案。通过`app.config.*.ts`文件实现环境隔离，配置管理器根据当前环境自动加载对应的配置文件。系统支持配置优先级机制，环境变量可以覆盖文件配置，并支持条件性配置加载。配置重载机制确保环境切换时配置的正确性，环境变量命名规范（APP_*前缀）和环境感知的构建流程进一步增强了系统的可靠性和可维护性。