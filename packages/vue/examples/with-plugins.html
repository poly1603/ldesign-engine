<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue3 Engine - With Plugins Example</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .plugin-card {
      background: #f9f9f9;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      border-left: 4px solid #42b983;
    }

    button {
      background: #42b983;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    button:hover {
      background: #35a372;
    }

    .log {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .log-entry {
      margin: 5px 0;
    }
  </style>
</head>

<body>
  <div id="app"></div>

  <script type="module">
    import { createApp, ref, computed } from 'vue'
    import { createEngineApp } from '@ldesign/engine-vue3'
    import { useEngine, useEvents } from '@ldesign/engine-vue3/composables'

    // ===== å®šä¹‰æ’ä»¶ =====

    // 1. æ—¥å¿—æ’ä»¶
    const loggerPlugin = {
      name: 'logger-plugin',
      version: '1.0.0',
      description: 'å¢å¼ºæ—¥å¿—åŠŸèƒ½',
      install({ engine, logger, events }) {
        logger.info('[LoggerPlugin] æ’ä»¶å·²å®‰è£…')

        // ç›‘å¬æ‰€æœ‰äº‹ä»¶å¹¶è®°å½•
        const originalEmit = events.emit.bind(events)
        events.emit = async function (eventName, data) {
          logger.debug(`[Event] ${eventName}`, data)
          return originalEmit(eventName, data)
        }
      }
    }

    // 2. åˆ†ææ’ä»¶
    const analyticsPlugin = {
      name: 'analytics-plugin',
      version: '1.0.0',
      description: 'ç”¨æˆ·è¡Œä¸ºåˆ†æ',
      dependencies: ['logger-plugin'], // ä¾èµ–æ—¥å¿—æ’ä»¶
      install({ engine, logger, events }) {
        logger.info('[AnalyticsPlugin] æ’ä»¶å·²å®‰è£…')

        const analytics = {
          pageViews: 0,
          userActions: [],
          trackPageView() {
            this.pageViews++
            logger.info(`[Analytics] é¡µé¢è®¿é—®æ¬¡æ•°: ${this.pageViews}`)
          },
          trackAction(action) {
            this.userActions.push({
              action,
              timestamp: Date.now()
            })
            logger.info(`[Analytics] ç”¨æˆ·æ“ä½œ:`, action)
          },
          getStats() {
            return {
              pageViews: this.pageViews,
              totalActions: this.userActions.length,
              recentActions: this.userActions.slice(-5)
            }
          }
        }

        // å°†åˆ†æå·¥å…·æŒ‚è½½åˆ°å¼•æ“
        engine.analytics = analytics

        // ç›‘å¬ç”¨æˆ·äº‹ä»¶
        events.on('user:action', (data) => {
          analytics.trackAction(data)
        })

        // åˆå§‹é¡µé¢è®¿é—®
        analytics.trackPageView()
      }
    }

    // 3. é€šçŸ¥æ’ä»¶
    const notificationPlugin = {
      name: 'notification-plugin',
      version: '1.0.0',
      description: 'æ¶ˆæ¯é€šçŸ¥ç³»ç»Ÿ',
      install({ engine, logger, events }) {
        logger.info('[NotificationPlugin] æ’ä»¶å·²å®‰è£…')

        const notifications = ref([])

        const notify = {
          show(message, type = 'info') {
            const id = Date.now()
            notifications.value.push({ id, message, type, timestamp: new Date() })

            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
              notifications.value = notifications.value.filter(n => n.id !== id)
            }, 3000)

            events.emit('notification:shown', { message, type })
          },
          success(message) {
            this.show(message, 'success')
          },
          error(message) {
            this.show(message, 'error')
          },
          getAll() {
            return notifications.value
          }
        }

        engine.notify = notify
        engine.notifications = notifications
      }
    }

    // ===== å®šä¹‰ä¸­é—´ä»¶ =====

    const authMiddleware = {
      name: 'auth',
      priority: 100,
      async handler(context, next) {
        console.log('[Middleware] Auth - éªŒè¯å¼€å§‹', context)
        await next()
        console.log('[Middleware] Auth - éªŒè¯å®Œæˆ')
      }
    }

    const loggingMiddleware = {
      name: 'logging',
      priority: 50,
      async handler(context, next) {
        const start = Date.now()
        console.log('[Middleware] Logging - è¯·æ±‚å¼€å§‹')
        await next()
        const duration = Date.now() - start
        console.log(`[Middleware] Logging - è¯·æ±‚å®Œæˆ (${duration}ms)`)
      }
    }

    // ===== å®šä¹‰æ ¹ç»„ä»¶ =====
    const App = {
      setup() {
        const engine = useEngine()
        const events = useEvents()

        const logs = ref([])
        const pluginStats = computed(() => engine.plugins.getStats())

        // æ·»åŠ æ—¥å¿—
        const addLog = (message, level = 'info') => {
          logs.value.push({
            time: new Date().toLocaleTimeString(),
            message,
            level
          })
        }

        // ç›‘å¬å¼•æ“äº‹ä»¶
        events.on('notification:shown', (data) => {
          addLog(`é€šçŸ¥: ${data.message} (${data.type})`, 'success')
        })

        // æ“ä½œæ–¹æ³•
        const trackAction = (actionName) => {
          events.emit('user:action', { name: actionName })
          if (engine.notify) {
            engine.notify.success(`æ“ä½œ "${actionName}" å·²è®°å½•`)
          }
        }

        const viewAnalytics = () => {
          if (engine.analytics) {
            const stats = engine.analytics.getStats()
            addLog(`åˆ†æç»Ÿè®¡: ${JSON.stringify(stats)}`, 'info')
            if (engine.notify) {
              engine.notify.show(`æ€»è®¿é—®: ${stats.pageViews}, æ€»æ“ä½œ: ${stats.totalActions}`)
            }
          }
        }

        const testMiddleware = async () => {
          addLog('æ‰§è¡Œä¸­é—´ä»¶æµ‹è¯•...', 'info')
          await engine.middleware.execute({
            request: { url: '/test', method: 'GET' }
          })
          addLog('ä¸­é—´ä»¶æ‰§è¡Œå®Œæˆ', 'success')
        }

        // åˆå§‹åŒ–æ—¥å¿—
        addLog('åº”ç”¨å·²å¯åŠ¨', 'success')
        addLog(`å·²åŠ è½½ ${pluginStats.value.installed} ä¸ªæ’ä»¶`, 'info')

        return {
          logs,
          pluginStats,
          notifications: engine.notifications || ref([]),
          trackAction,
          viewAnalytics,
          testMiddleware
        }
      },
      template: `
        <div class="container">
          <h1>ğŸ”Œ Vue3 Engine - æ’ä»¶ç³»ç»Ÿç¤ºä¾‹</h1>
          
          <div class="plugin-card">
            <h3>å·²å®‰è£…æ’ä»¶</h3>
            <ul>
              <li v-for="name in pluginStats.loaded" :key="name">
                âœ… {{ name }}
              </li>
            </ul>
            <p>æ€»è®¡: {{ pluginStats.total }} ä¸ªæ’ä»¶</p>
          </div>
          
          <h3>æ“ä½œé¢æ¿</h3>
          <div style="margin: 20px 0;">
            <button @click="trackAction('ç‚¹å‡»æŒ‰é’®')">è®°å½•æ“ä½œ</button>
            <button @click="viewAnalytics">æŸ¥çœ‹ç»Ÿè®¡</button>
            <button @click="testMiddleware">æµ‹è¯•ä¸­é—´ä»¶</button>
          </div>
          
          <div v-if="notifications.length > 0" style="margin: 20px 0;">
            <h3>é€šçŸ¥</h3>
            <div v-for="notif in notifications" :key="notif.id" 
                 style="background: #e7f3ff; padding: 10px; margin: 5px 0; border-radius: 4px;">
              <strong>{{ notif.type.toUpperCase() }}:</strong> {{ notif.message }}
            </div>
          </div>
          
          <h3>æ—¥å¿—</h3>
          <div class="log">
            <div v-for="(log, index) in logs" :key="index" class="log-entry">
              <span style="color: #3498db;">[{{ log.time }}]</span>
              <span :style="{ color: log.level === 'error' ? '#e74c3c' : log.level === 'success' ? '#2ecc71' : '#ecf0f1' }">
                {{ log.message }}
              </span>
            </div>
          </div>
        </div>
      `
    }

    // ===== åˆ›å»ºåº”ç”¨ =====
    const engine = await createEngineApp({
      rootComponent: App,
      mountElement: '#app',
      config: {
        name: 'Plugin Demo',
        version: '1.0.0',
        debug: true
      },
      plugins: [
        loggerPlugin,
        analyticsPlugin,  // ä¾èµ– loggerPlugin
        notificationPlugin
      ],
      middleware: [
        authMiddleware,
        loggingMiddleware
      ],
      onReady: (engine) => {
        console.log('âœ… Engine ready!', engine.getStatus())
      },
      onMounted: (engine) => {
        console.log('âœ… App mounted!', engine.getStatus())
      }
    })

    // å…¨å±€è®¿é—®ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    window.engine = engine
    console.log('ğŸ’¡ æç¤º: å¯ä»¥åœ¨æ§åˆ¶å°ä½¿ç”¨ window.engine è®¿é—®å¼•æ“å®ä¾‹')
  </script>
</body>

</html>