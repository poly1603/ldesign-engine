<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue3 Engine - With Plugins Example</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .plugin-card {
      background: #f9f9f9;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      border-left: 4px solid #42b983;
    }

    button {
      background: #42b983;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    button:hover {
      background: #35a372;
    }

    .log {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .log-entry {
      margin: 5px 0;
    }
  </style>
</head>

<body>
  <div id="app"></div>

  <script type="module">
    import { createApp, ref, computed } from 'vue'
    import { createEngineApp } from '@ldesign/engine-vue3'
    import { useEngine, useEvents } from '@ldesign/engine-vue3/composables'

    // ===== 定义插件 =====

    // 1. 日志插件
    const loggerPlugin = {
      name: 'logger-plugin',
      version: '1.0.0',
      description: '增强日志功能',
      install({ engine, logger, events }) {
        logger.info('[LoggerPlugin] 插件已安装')

        // 监听所有事件并记录
        const originalEmit = events.emit.bind(events)
        events.emit = async function (eventName, data) {
          logger.debug(`[Event] ${eventName}`, data)
          return originalEmit(eventName, data)
        }
      }
    }

    // 2. 分析插件
    const analyticsPlugin = {
      name: 'analytics-plugin',
      version: '1.0.0',
      description: '用户行为分析',
      dependencies: ['logger-plugin'], // 依赖日志插件
      install({ engine, logger, events }) {
        logger.info('[AnalyticsPlugin] 插件已安装')

        const analytics = {
          pageViews: 0,
          userActions: [],
          trackPageView() {
            this.pageViews++
            logger.info(`[Analytics] 页面访问次数: ${this.pageViews}`)
          },
          trackAction(action) {
            this.userActions.push({
              action,
              timestamp: Date.now()
            })
            logger.info(`[Analytics] 用户操作:`, action)
          },
          getStats() {
            return {
              pageViews: this.pageViews,
              totalActions: this.userActions.length,
              recentActions: this.userActions.slice(-5)
            }
          }
        }

        // 将分析工具挂载到引擎
        engine.analytics = analytics

        // 监听用户事件
        events.on('user:action', (data) => {
          analytics.trackAction(data)
        })

        // 初始页面访问
        analytics.trackPageView()
      }
    }

    // 3. 通知插件
    const notificationPlugin = {
      name: 'notification-plugin',
      version: '1.0.0',
      description: '消息通知系统',
      install({ engine, logger, events }) {
        logger.info('[NotificationPlugin] 插件已安装')

        const notifications = ref([])

        const notify = {
          show(message, type = 'info') {
            const id = Date.now()
            notifications.value.push({ id, message, type, timestamp: new Date() })

            // 3秒后自动移除
            setTimeout(() => {
              notifications.value = notifications.value.filter(n => n.id !== id)
            }, 3000)

            events.emit('notification:shown', { message, type })
          },
          success(message) {
            this.show(message, 'success')
          },
          error(message) {
            this.show(message, 'error')
          },
          getAll() {
            return notifications.value
          }
        }

        engine.notify = notify
        engine.notifications = notifications
      }
    }

    // ===== 定义中间件 =====

    const authMiddleware = {
      name: 'auth',
      priority: 100,
      async handler(context, next) {
        console.log('[Middleware] Auth - 验证开始', context)
        await next()
        console.log('[Middleware] Auth - 验证完成')
      }
    }

    const loggingMiddleware = {
      name: 'logging',
      priority: 50,
      async handler(context, next) {
        const start = Date.now()
        console.log('[Middleware] Logging - 请求开始')
        await next()
        const duration = Date.now() - start
        console.log(`[Middleware] Logging - 请求完成 (${duration}ms)`)
      }
    }

    // ===== 定义根组件 =====
    const App = {
      setup() {
        const engine = useEngine()
        const events = useEvents()

        const logs = ref([])
        const pluginStats = computed(() => engine.plugins.getStats())

        // 添加日志
        const addLog = (message, level = 'info') => {
          logs.value.push({
            time: new Date().toLocaleTimeString(),
            message,
            level
          })
        }

        // 监听引擎事件
        events.on('notification:shown', (data) => {
          addLog(`通知: ${data.message} (${data.type})`, 'success')
        })

        // 操作方法
        const trackAction = (actionName) => {
          events.emit('user:action', { name: actionName })
          if (engine.notify) {
            engine.notify.success(`操作 "${actionName}" 已记录`)
          }
        }

        const viewAnalytics = () => {
          if (engine.analytics) {
            const stats = engine.analytics.getStats()
            addLog(`分析统计: ${JSON.stringify(stats)}`, 'info')
            if (engine.notify) {
              engine.notify.show(`总访问: ${stats.pageViews}, 总操作: ${stats.totalActions}`)
            }
          }
        }

        const testMiddleware = async () => {
          addLog('执行中间件测试...', 'info')
          await engine.middleware.execute({
            request: { url: '/test', method: 'GET' }
          })
          addLog('中间件执行完成', 'success')
        }

        // 初始化日志
        addLog('应用已启动', 'success')
        addLog(`已加载 ${pluginStats.value.installed} 个插件`, 'info')

        return {
          logs,
          pluginStats,
          notifications: engine.notifications || ref([]),
          trackAction,
          viewAnalytics,
          testMiddleware
        }
      },
      template: `
        <div class="container">
          <h1>🔌 Vue3 Engine - 插件系统示例</h1>
          
          <div class="plugin-card">
            <h3>已安装插件</h3>
            <ul>
              <li v-for="name in pluginStats.loaded" :key="name">
                ✅ {{ name }}
              </li>
            </ul>
            <p>总计: {{ pluginStats.total }} 个插件</p>
          </div>
          
          <h3>操作面板</h3>
          <div style="margin: 20px 0;">
            <button @click="trackAction('点击按钮')">记录操作</button>
            <button @click="viewAnalytics">查看统计</button>
            <button @click="testMiddleware">测试中间件</button>
          </div>
          
          <div v-if="notifications.length > 0" style="margin: 20px 0;">
            <h3>通知</h3>
            <div v-for="notif in notifications" :key="notif.id" 
                 style="background: #e7f3ff; padding: 10px; margin: 5px 0; border-radius: 4px;">
              <strong>{{ notif.type.toUpperCase() }}:</strong> {{ notif.message }}
            </div>
          </div>
          
          <h3>日志</h3>
          <div class="log">
            <div v-for="(log, index) in logs" :key="index" class="log-entry">
              <span style="color: #3498db;">[{{ log.time }}]</span>
              <span :style="{ color: log.level === 'error' ? '#e74c3c' : log.level === 'success' ? '#2ecc71' : '#ecf0f1' }">
                {{ log.message }}
              </span>
            </div>
          </div>
        </div>
      `
    }

    // ===== 创建应用 =====
    const engine = await createEngineApp({
      rootComponent: App,
      mountElement: '#app',
      config: {
        name: 'Plugin Demo',
        version: '1.0.0',
        debug: true
      },
      plugins: [
        loggerPlugin,
        analyticsPlugin,  // 依赖 loggerPlugin
        notificationPlugin
      ],
      middleware: [
        authMiddleware,
        loggingMiddleware
      ],
      onReady: (engine) => {
        console.log('✅ Engine ready!', engine.getStatus())
      },
      onMounted: (engine) => {
        console.log('✅ App mounted!', engine.getStatus())
      }
    })

    // 全局访问（用于调试）
    window.engine = engine
    console.log('💡 提示: 可以在控制台使用 window.engine 访问引擎实例')
  </script>
</body>

</html>