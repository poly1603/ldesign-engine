{"version":3,"file":"infinite-scroll.cjs","sources":["../../../src/directives/modules/infinite-scroll.ts"],"sourcesContent":["/**\r\n * 无限滚动指令\r\n * 当滚动到底部时触发加载更多数据\r\n */\r\n\r\nimport type { VueDirectiveBinding } from '../base/vue-directive-adapter'\r\nimport { DirectiveBase } from '../base/directive-base'\r\nimport { defineDirective, directiveUtils } from '../base/vue-directive-adapter'\r\n\r\nexport interface InfiniteScrollOptions {\r\n  callback?: () => void | Promise<void>\r\n  distance?: number\r\n  disabled?: boolean\r\n  immediate?: boolean\r\n  container?: string | HTMLElement\r\n  delay?: number\r\n}\r\n\r\nexport class InfiniteScrollDirective extends DirectiveBase {\r\n  constructor() {\r\n    super({\r\n      name: 'infinite-scroll',\r\n      description: '无限滚动加载更多数据',\r\n      version: '1.0.0',\r\n      category: 'interaction',\r\n      tags: ['infinite', 'scroll', 'load-more', 'pagination'],\r\n    })\r\n  }\r\n\r\n  public mounted(el: HTMLElement, binding: VueDirectiveBinding): void {\r\n    const config = this.parseConfig(binding)\r\n\r\n    if (!config.callback || typeof config.callback !== 'function') {\r\n      this.warn('Infinite scroll directive requires a callback function')\r\n      return\r\n    }\r\n\r\n    const distance = config.distance ?? 100\r\n    const delay = config.delay ?? 200\r\n    const container = this.getContainer(el, config.container)\r\n\r\n    let isLoading = false\r\n    let timeoutId: NodeJS.Timeout | null = null\r\n\r\n    const handleScroll = async () => {\r\n      if (config.disabled || isLoading) return\r\n\r\n      // Clear existing timeout\r\n      if (timeoutId) {\r\n        clearTimeout(timeoutId)\r\n        timeoutId = null // 释放引用\r\n      }\r\n\r\n      // Debounce the scroll handler\r\n      timeoutId = setTimeout(async () => {\r\n        const scrollTop = container === window ?\r\n          window.pageYOffset || document.documentElement.scrollTop :\r\n          (container as HTMLElement).scrollTop\r\n\r\n        const scrollHeight = container === window ?\r\n          document.documentElement.scrollHeight :\r\n          (container as HTMLElement).scrollHeight\r\n\r\n        const clientHeight = container === window ?\r\n          window.innerHeight :\r\n          (container as HTMLElement).clientHeight\r\n\r\n        if (scrollTop + clientHeight >= scrollHeight - distance) {\r\n          isLoading = true\r\n          try {\r\n            if (config.callback) {\r\n              await config.callback()\r\n            }\r\n          } catch (error) {\r\n            this.warn('Error in infinite scroll callback:', error)\r\n          } finally {\r\n            isLoading = false\r\n          }\r\n        }\r\n        timeoutId = null // 清理引用\r\n      }, delay)\r\n    }\r\n\r\n    // Store handler and container for cleanup\r\n    directiveUtils.storeData(el, 'infinite-scroll-handler', handleScroll)\r\n    directiveUtils.storeData(el, 'infinite-scroll-container', container)\r\n    directiveUtils.storeData(el, 'infinite-scroll-timeout', timeoutId)\r\n\r\n    // Add scroll listener\r\n    container.addEventListener('scroll', handleScroll, { passive: true })\r\n\r\n    // Execute immediately if specified\r\n    if (config.immediate) {\r\n      handleScroll()\r\n    }\r\n\r\n    this.log('Infinite scroll directive mounted', el)\r\n  }\r\n\r\n  public updated(el: HTMLElement, binding: VueDirectiveBinding): void {\r\n    // Clean up old listener\r\n    this.cleanup(el)\r\n\r\n    // Re-mount with new config\r\n    this.mounted(el, binding)\r\n\r\n    this.log('Infinite scroll directive updated', el)\r\n  }\r\n\r\n  public unmounted(el: HTMLElement): void {\r\n    this.cleanup(el)\r\n    this.log('Infinite scroll directive unmounted', el)\r\n  }\r\n\r\n  private cleanup(el: HTMLElement): void {\r\n    const handler = directiveUtils.getData(el, 'infinite-scroll-handler')\r\n    const container = directiveUtils.getData(el, 'infinite-scroll-container')\r\n    const timeout = directiveUtils.getData(el, 'infinite-scroll-timeout')\r\n\r\n    // 清理事件监听器\r\n    if (handler && container) {\r\n      const typedContainer = container as HTMLElement | Window\r\n      typedContainer.removeEventListener('scroll', handler as EventListener)\r\n    }\r\n\r\n    // 清理定时器\r\n    if (timeout) {\r\n      clearTimeout(timeout as NodeJS.Timeout)\r\n    }\r\n\r\n    // 清理存储的数据，避免内存泄漏\r\n    directiveUtils.removeData(el, 'infinite-scroll-handler')\r\n    directiveUtils.removeData(el, 'infinite-scroll-container')\r\n    directiveUtils.removeData(el, 'infinite-scroll-timeout')\r\n    \r\n    // 清理元素的引用\r\n    if (el && typeof el === 'object') {\r\n      (el as any).__infiniteScroll = null\r\n    }\r\n  }\r\n\r\n  private getContainer(el: HTMLElement, container?: string | HTMLElement): HTMLElement | Window {\r\n    if (!container) {\r\n      return window\r\n    }\r\n\r\n    if (typeof container === 'string') {\r\n      const containerEl = document.querySelector(container) as HTMLElement\r\n      return containerEl || window\r\n    }\r\n\r\n    return container\r\n  }\r\n\r\n  private parseConfig(binding: VueDirectiveBinding): InfiniteScrollOptions {\r\n    const value = binding.value\r\n\r\n    if (typeof value === 'function') {\r\n      return { callback: value as () => void | Promise<void> }\r\n    }\r\n\r\n    if (typeof value === 'object' && value !== null) {\r\n      return value as InfiniteScrollOptions\r\n    }\r\n\r\n    return {}\r\n  }\r\n\r\n  public getExample(): string {\r\n    return `\r\n<!-- Basic infinite scroll -->\r\n<div v-infinite-scroll=\"loadMore\" class=\"list-container\">\r\n  <div v-for=\"item in items\" :key=\"item.id\" class=\"list-item\">\r\n    {{ item.name }}\r\n  </div>\r\n  <div v-if=\"loading\" class=\"loading\">Loading...</div>\r\n</div>\r\n\r\n<!-- With options -->\r\n<div v-infinite-scroll=\"{\r\n  callback: loadMoreData,\r\n  distance: 200,\r\n  delay: 300,\r\n  immediate: true\r\n}\" class=\"scroll-container\">\r\n  <article v-for=\"post in posts\" :key=\"post.id\">\r\n    {{ post.title }}\r\n  </article>\r\n</div>\r\n\r\n<!-- Custom container -->\r\n<div class=\"wrapper\">\r\n  <div \r\n    v-infinite-scroll=\"{\r\n      callback: fetchMore,\r\n      container: '.scroll-area',\r\n      disabled: isDisabled\r\n    }\"\r\n    class=\"scroll-area\"\r\n    style=\"height: 500px; overflow-y: auto;\"\r\n  >\r\n    <div v-for=\"n in count\" :key=\"n\">\r\n      Item {{ n }}\r\n    </div>\r\n  </div>\r\n</div>\r\n\r\n<script setup>\r\nimport { ref } from 'vue'\r\n\r\nconst items = ref([])\r\nconst loading = ref(false)\r\nconst hasMore = ref(true)\r\n\r\nconst loadMore = async () => {\r\n  if (loading.value || !hasMore.value) return\r\n  \r\n  loading.value = true\r\n  try {\r\n    const response = await fetch('/api/items?page=' + nextPage)\r\n    const data = await response.json()\r\n    items.value.push(...data.items)\r\n    hasMore.value = data.hasMore\r\n  } finally {\r\n    loading.value = false\r\n  }\r\n}\r\n</script>\r\n    `\r\n  }\r\n}\r\n\r\n// Export the directive definition\r\nexport const vInfiniteScroll = defineDirective(new InfiniteScrollDirective())\r\n\r\n// Export default for convenience\r\nexport default vInfiniteScroll\r\n"],"names":["DirectiveBase","directiveUtils","defineDirective"],"mappings":"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"}